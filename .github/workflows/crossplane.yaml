name: Publish Crossplane Packages

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      # Trigger workflow if workflow file is updated to validate it works appropriately
      - .github/workflows/crossplane.yaml
      # Trigger workflow if commit contains changes to configuration stored in the OCI artifact
      - k8s/namespaces/base/crossplane-system/crossplane/packages/**

env:
  GHCR_REPO: "ghcr.io/xunholy/crossplane/packages/"
  PACKAGE_DIR: "k8s/namespaces/base/crossplane-system/crossplane/packages"

jobs:
  generate_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3

      - name: Generate matrix
        id: set-matrix
        run: |
          FOLDER_LIST=$(find $PACKAGE_DIR -mindepth 1 -maxdepth 1 -type d -printf '%P\n' | jq -R -s -c 'split("\n")[:-1]')
          echo "Folders: $FOLDER_LIST"
          echo "::set-output name=matrix::{\"folder\": $FOLDER_LIST}"

  build:
    needs: generate_matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: ${{fromJson(needs.generate_matrix.outputs.matrix).folder}}
    steps:
      - name: Checkout
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3

      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Setup Tools
        run: |
          brew install kubernetes-cli

      - name: Setup Crossplane CLI
        run: |
          curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh | sh
          sudo mv kubectl-crossplane /home/linuxbrew/.linuxbrew/bin

      - name: Login to GHCR
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a # v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        run: |
          cd $PACKAGE_DIR/${{ matrix.folder }}
          kubectl crossplane build configuration
          kubectl crossplane push configuration ghcr.io/xunholy/crossplane/packages/${{ matrix.folder }}:v0.0.1
