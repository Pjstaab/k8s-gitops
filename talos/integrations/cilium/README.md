# Cilium

Install the cilium CLI [here](https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/)

The following installation guide can be followed [here](https://docs.cilium.io/en/v1.9/gettingstarted/kubeproxy-free/#kubeproxy-free)

```bash
kubectl -n kube-system delete ds kube-proxy
```

```bash
helm repo add cilium https://helm.cilium.io/
```

```bash
helm install cilium cilium/cilium \
  --version=1.12.1 \
  --namespace=kube-system \
  --values=k8s/namespaces/base/kube-system/cilium/install/1.12.1.yaml
```

Post successful installation of Cilium it's option to run the Cilium network connectivity tests

https://docs.cilium.io/en/v1.10/operations/troubleshooting/#cilium-connectivity-tests

Upgrade path

```bash
helm upgrade cilium cilium/cilium \
  --version 1.21.1 \
  --namespace=kube-system \
  --values=k8s/namespaces/base/kube-system/cilium/install/1.12.1.yaml
```

## Service Mesh

```bash
git clone https://github.com/cilium/cilium.git
cd cilium
git checkout origin/beta/service-mesh
helm upgrade -n kube-system cilium ./install/kubernetes/cilium --values=../k8s-gitops/k8s/namespaces/base/kube-system/cilium/install/values.yaml
```

## Manual Local Templating

```bash
helm template cilium/cilium \
  --version=1.12.1 \
  --namespace=kube-system \
  --values=k8s/namespaces/base/kube-system/cilium/install/1.12.1.yaml > k8s/namespaces/base/kube-system/cilium/install/cilium-1-12-1.yaml
```

```bash
flux create helmrelease cilium \
  --source=HelmRepository/cilium-chart \
  --namespace=kube-system \
  --chart=cilium \
  --chart-version=1.12.1 \
  --values=k8s/namespaces/base/kube-system/cilium/install/1.12.1.yaml \
  --export > k8s/namespaces/base/kube-system/cilium/install/helmrelease.yaml
```

## Create Static Cilium Locally For Talos

```bash
echo "Removing old local chart cache"
rm -rf talos/integrations/cilium/charts
echo "# This manifest was generated by automation. DO NOT EDIT." > talos/integrations/cilium/cilium.yaml
kustomize build \
  --enable-helm \
  --load-restrictor=LoadRestrictionsNone \
 talos/integrations/cilium \
  >> talos/integrations/cilium/cilium.yaml
```
