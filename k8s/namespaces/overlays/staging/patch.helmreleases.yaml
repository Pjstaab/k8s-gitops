---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: external-dns
  namespace: network
spec:
  values:
    policy: upsert-only
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: network
spec:
  values:
    extraArgs:
      oidc-issuer-url: https://dex.stg.raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dex
  namespace: network
spec:
  values:
    config:
      issuer: https://dex.stg.raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  values:
    grafana:
      grafana.ini:
        server:
          root_url: https://grafana.stg.raspbernetes.com
        auth.generic_oauth:
          auth_url: https://dex.stg.raspbernetes.com/auth
          token_url: https://dex.stg.raspbernetes.com/token
          api_url: https://dex.stg.raspbernetes.com/userinfo
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: metallb
  namespace: network
spec:
  values:
    configInline:
      address-pools:
        - name: default
          protocol: layer2
          addresses:
            - 192.168.1.180-192.168.1.185
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: coredns
  namespace: network
spec:
  values:
    service:
      loadBalancerIP: 192.168.1.181
    zoneFiles:
      - filename: raspbernetes.db
        domain: raspbernetes.com
        contents: |
          raspbernetes.com.   IN SOA    ns.dns.raspbernetes.com. hostmaster.raspbernetes.com. 1610541154 7200 1800 86400 30
          raspbernetes.com.   IN NS     ns.dns.raspbernetes.com.
          raspbernetes.com.   IN A      192.168.1.180
          *.stg.raspbernetes.com. IN CNAME  raspbernetes.com.
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mosquitto
  namespace: home-system
spec:
  values:
    service:
      main:
        loadBalancerIP: 192.168.1.152
